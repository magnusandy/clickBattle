<!DOCTYPE HTML> 
<html lang="en"> 
<head>
	<title>Click Battle</title>
	<script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
	<script>
	var peer = new Peer({
		key: 'x27qwxzxluwhfr',
		debug: 3,
		logFunction: function() {
			console.log(arguments);
		}
	});
	
	var connectedPeers = {};
	
	peer.on('open', openConnection)
	// Await connections from others
	peer.on('connection', onConnect);
	
	function onConnect(dataConnection)
	{
        document.getElementById('yourLink').style.display = 'none'; //hide the link box  
		document.getElementById('theirID').innerHTML = 'Connected'
		connectedPeers = dataConnection
		console.log(connectedPeers);
		dataConnection.on('data', dataGot);
	}
	
	function dataGot(data)
	{
		document.getElementById('theirScore').innerHTML = 'Their Score: '+data;
	}
	
	
	function openConnection(id)
	{
        var idFromLink = getQueryVariable('id');
        console.log(idFromLink)
        if(idFromLink == false)//there is nothing in the address or it is malformed
        {
            document.getElementById('yourLink').style.display = 'inline'; //show the link box   
            //load normally and generate link
		               var linux = 'file:///home/magnusandy/Documents/Github/clickBattle/index.html?id='+id
            console.log('Linux Link'+linux)
            document.getElementById('yourLink').value= linux
        }
        else//there is a id in the address
        {

            clickConnect(idFromLink);
        }
	}
	
	function clickConnect(requestedPeer)
	{
	    var c = peer.connect(requestedPeer, {
        label: 'chat',
        serialization: 'none',
        metadata: {message: 'hi i want to chat with you!'}
      });
      c.on('open', function() {
        onConnect(c);
      });
      c.on('error', function(err) { alert(err); });
	}
	
	var i = 0;
	function clickButton()
	{
		i=i+1;
		connectedPeers.send(i);
		document.getElementById('yourScore').innerHTML = 'Your Score: '+i;
	}
	
	
	
	
	
	
	window.onunload = window.onbeforeunload = function(e) {
  if (!!peer && !peer.destroyed) {
    peer.destroy();
  }
};

//functions
function getQueryVariable(variable)
	{
		   var query = window.location.search.substring(0);
           if(query.includes('?'))
            {
                query = query.substring(1)
                console.log('here')
		       var vars = query.split("&");
		       for (var i=0;i<vars.length;i) {
				       var pair = vars[i].split("=");
				       if(pair[0] == variable){return pair[1];}
		       }
            }
            else//there is no address variable
            {
                return(false);
            }
		        
	}
	</script>
</head>
<body>
	<h1 id='yourID'></h1>
    <input id='yourLink' style='display:none'></input>
	<h1 id='theirID'></h1>
	<input id='theirIDType'></input>
	<button onclick='clickConnect()'>Connect</button>
	<button onclick='clickButton()'>PRESS ME</button>
	<p id='yourScore'>Your Score: </p>
	<p id='theirScore'>Their Score:</p>
</body>
